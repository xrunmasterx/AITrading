# AITrading 量化分析软件 - 功能详细文档

## v2.0 更新说明

### 新增功能
- **自选股管理**: 支持添加、删除、切换自选股票
- **实时监控引擎**: 分钟级价格监控，自动刷新
- **价格预警系统**: 支持上下限预警，QQ邮箱通知
- **智能增量更新**: 仅拉取缺失数据，避免API浪费
- **冷热数据分层**: 静态数据日更，实时数据分钟更

## 📋 目录

1. [系统概述](#系统概述)
2. [核心功能模块](#核心功能模块)
   - [数据采集模块](#1-数据采集模块)
   - [量化策略分析模块](#2-量化策略分析模块)
   - [舆情分析模块](#3-舆情分析模块)
   - [股票分析器模块](#4-股票分析器模块)
   - [AI上下文管理模块](#5-ai上下文管理模块)
   - [可视化界面模块](#6-可视化界面模块)
   - [数据库存储模块](#7-数据库存储模块)
   - [自选股管理模块 (v2.0)](#8-自选股管理模块-v20)
   - [实时监控引擎 (v2.0)](#9-实时监控引擎-v20)
   - [价格预警系统 (v2.0)](#10-价格预警系统-v20)
3. [技术特性](#技术特性)
4. [使用指南](#使用指南)

---

## 系统概述

**AITrading** 是一款面向美股和港股的个人量化分析工具，专注于单只股票的深度分析。系统通过多数据源采集、智能分析、AI上下文记录和可视化展示，为投资者提供全面的股票分析支持。

### 核心设计理念

- **单股票深度分析**：每次专注于一只股票，提供全面深入的分析
- **多数据源融合**：整合 yfinance、Finnhub、Alpha Vantage 等多个数据源
- **智能缓存机制**：本地缓存减少API调用，提高响应速度
- **AI上下文记录**：自动记录分析历史，便于AI模型理解股票变化趋势

---

## 核心功能模块

### 1. 数据采集模块 (`app/services/data_fetcher.py`)

数据采集模块是整个系统的数据基础，负责从多个数据源获取股票相关数据。

#### 1.1 数据源配置

**主要数据源：**
- **yfinance**：主力数据源，免费且数据全面
- **Finnhub**：新闻和情绪数据补充
- **Alpha Vantage**：备用数据源（免费版限制较多）

**数据源优先级策略：**
```
yfinance (重试2次) → 本地缓存 → Alpha Vantage (最后备用)
```

#### 1.2 核心功能

##### 1.2.1 股票基本信息获取 (`get_stock_info`)

**功能描述：**
获取股票的基本信息，包括公司名称、行业、市值、PE/PB等财务指标。

**数据来源：**
- yfinance `ticker.info` 或 `ticker.fast_info`
- Alpha Vantage（备用）

**返回数据：**
```python
StockInfo {
    symbol: str          # 股票代码
    name: str            # 公司名称
    market: str          # 市场（US/HK）
    sector: str          # 行业板块
    industry: str        # 细分行业
    market_cap: float    # 市值
    pe_ratio: float      # 市盈率
    pb_ratio: float      # 市净率
    dividend_yield: float # 股息率
    description: str     # 公司简介
}
```

**缓存机制：**
- 内存缓存：10分钟有效期
- 自动复用，减少API调用

##### 1.2.2 实时价格获取 (`get_current_price`)

**功能描述：**
获取股票的实时价格和当日交易数据。

**数据来源：**
- yfinance `ticker.fast_info`（轻量级，优先使用）
- Alpha Vantage（备用）

**返回数据：**
```python
MarketOverview {
    current_price: float    # 当前价格
    prev_close: float       # 昨收价
    open_price: float       # 开盘价
    day_high: float         # 今日最高
    day_low: float          # 今日最低
    volume: int             # 成交量
    avg_volume: int         # 平均成交量
    week_52_high: float     # 52周最高
    week_52_low: float      # 52周最低
}
```

**优化特性：**
- 使用 `fast_info` 替代 `info`，减少API调用
- 自动重试机制（最多2次）
- 请求间隔控制（1.5秒）

##### 1.2.3 历史价格数据获取 (`get_price_history`)

**功能描述：**
获取股票的历史K线数据，支持多种时间周期。

**支持的时间周期：**
- `1mo`：1个月（约22个交易日）
- `3mo`：3个月（约65个交易日）
- `6mo`：6个月（约130个交易日）
- `1y`：1年（约252个交易日）
- `2y`：2年（约504个交易日）

**数据来源：**
- yfinance `ticker.history(start, end)`（使用日期范围，更稳定）
- 本地CSV缓存（`data/cache/{symbol}_history.csv`）
- Alpha Vantage（备用，最多100条）

**返回数据：**
```python
List[StockPrice] {
    symbol: str           # 股票代码
    timestamp: datetime   # 时间戳
    open: float          # 开盘价
    high: float          # 最高价
    low: float           # 最低价
    close: float         # 收盘价
    volume: int          # 成交量
    adj_close: float     # 复权收盘价
    change: float        # 涨跌额
    change_percent: float # 涨跌幅
}
```

**缓存机制：**
- **内存缓存**：10分钟有效期，快速访问
- **文件缓存**：CSV格式，保存到 `data/cache/` 目录
- **缓存有效期**：1天（超过则重新获取）
- **智能截取**：根据请求周期自动截取所需数据量

**优化策略：**
- 使用 `start/end` 日期范围而非 `period`，更精确控制
- 自动保存到本地CSV，限速时从缓存读取
- 根据周期智能截取，避免获取过多数据

##### 1.2.4 新闻数据获取 (`get_company_news_extended`)

**功能描述：**
获取与股票相关的新闻资讯，支持多数据源融合。

**数据来源：**
- Finnhub（主要，26条）
- yfinance（补充，10条）
- 自动去重（基于标题）

**返回数据：**
```python
List[StockNews] {
    symbol: str          # 股票代码
    title: str          # 新闻标题
    summary: str        # 新闻摘要
    source: str         # 来源
    url: str            # 链接
    published_at: datetime # 发布时间
    sentiment: str      # 情绪标签（positive/negative/neutral）
    sentiment_score: float # 情绪得分（-1.0 到 1.0）
}
```

**数据量：**
- 目标：至少50条新闻
- 实际：通常获取26-36条（去重后）

##### 1.2.5 财报数据获取 (`get_earnings`)

**功能描述：**
获取公司的财报数据，包括EPS、收入等关键指标。

**数据来源：**
- yfinance `ticker.earnings_dates`（财报日期和EPS）
- yfinance `ticker.earnings_history`（历史收益）
- Finnhub（财报日历，可选）

**返回数据：**
```python
List[Dict] {
    "date": str              # 财报日期
    "type": str              # 类型（quarterly/annual/history）
    "eps_estimate": float    # 预期EPS
    "reported_eps": float    # 实际EPS
    "surprise": float        # 惊喜百分比
    "source": str            # 数据源
}
```

**数据量：**
- 最近12个季度的财报数据
- 包含EPS实际值、预期值、惊喜率

##### 1.2.6 财务数据获取 (`get_financials`)

**功能描述：**
获取完整的财务数据，包括资产负债表、现金流、收入报表等。

**数据来源：**
- yfinance `ticker.balance_sheet`（资产负债表）
- yfinance `ticker.cashflow`（现金流）
- yfinance `ticker.income_stmt`（收入报表）
- yfinance `ticker.institutional_holders`（机构持有者）
- yfinance `ticker.analyst_price_targets`（目标价）
- yfinance `ticker.growth_estimates`（增长预估）

**返回数据结构：**

**资产负债表：**
```python
List[Dict] {
    "date": str
    "total_assets": float      # 总资产
    "total_liabilities": float # 总负债
    "total_equity": float      # 股东权益
    "cash": float             # 现金及等价物
}
```

**现金流：**
```python
List[Dict] {
    "date": str
    "operating_cashflow": float  # 经营现金流
    "investing_cashflow": float   # 投资现金流
    "financing_cashflow": float   # 融资现金流
    "free_cashflow": float        # 自由现金流
}
```

**收入报表：**
```python
List[Dict] {
    "date": str
    "total_revenue": float    # 总收入
    "gross_profit": float     # 毛利润
    "operating_income": float # 经营利润
    "net_income": float       # 净利润
}
```

**机构持有者：**
```python
List[Dict] {
    "holder": str            # 机构名称
    "shares": int           # 持股数量
    "date_reported": str     # 报告日期
    "percent_out": float     # 持股比例
    "value": float          # 持股价值
}
```

**分析预测：**
```python
Dict {
    "growth_estimates": {
        "current_qtr": float  # 本季度增长预估
        "next_qtr": float     # 下季度增长预估
        "current_year": float  # 本年度增长预估
        "next_year": float     # 下年度增长预估
    },
    "price_targets": {
        "current": float      # 当前目标价
        "low": float          # 最低目标价
        "high": float         # 最高目标价
        "mean": float         # 平均目标价
        "median": float       # 中位数目标价
    }
}
```

**数据量：**
- 资产负债表：最近4个季度
- 现金流：最近4个季度
- 收入报表：最近4个季度
- 机构持有者：Top 10
- 分析预测：当前和未来季度/年度

##### 1.2.7 分析师评级获取 (`get_analyst_ratings`)

**功能描述：**
获取机构分析师对股票的评级和目标价。

**数据来源：**
- yfinance `ticker.recommendations`（推荐历史）
- Finnhub（免费版不支持，需付费）

**返回数据：**
```python
List[Dict] {
    "date": str              # 评级日期
    "firm": str             # 机构名称
    "rating": str           # 评级（Buy/Hold/Sell等）
    "action": str           # 动作（Initiated/Upgraded/Downgraded）
    "target_price": float   # 目标价
    "source": str           # 数据源
}
```

##### 1.2.8 SEC文件获取 (`get_sec_filings`)

**功能描述：**
获取美国证券交易委员会（SEC）的监管文件。

**数据来源：**
- yfinance `ticker.sec_filings`

**返回数据：**
```python
List[Dict] {
    "filing_date": str      # 文件日期
    "form_type": str        # 文件类型（10-K, 10-Q等）
    "title": str           # 文件标题
    "url": str             # 文件链接
}
```

**文件类型：**
- `10-K`：年度报告
- `10-Q`：季度报告
- `8-K`：重大事件报告
- `DEF 14A`：代理声明

**数据量：**
- 最近30条SEC文件

##### 1.2.9 内部人交易获取 (`get_insider_transactions`)

**功能描述：**
获取公司内部人员（高管、董事）的股票交易记录。

**数据来源：**
- yfinance `ticker.insider_transactions`

**返回数据：**
```python
List[Dict] {
    "name": str                    # 内部人姓名
    "transaction_type": str        # 交易类型（buy/sell）
    "shares": int                 # 交易股数
    "price": float                # 交易价格
    "transaction_date": str       # 交易日期
    "value": float                # 交易价值
}
```

#### 1.3 请求限速控制

**限速策略：**
- **请求间隔**：1.5秒（符合Yahoo Finance的2000次/小时限制）
- **重试机制**：最多2次重试
- **重试间隔**：3秒递增（第1次3秒，第2次6秒）
- **限速检测**：自动检测限速，暂停60秒

**Ticker对象复用：**
- 缓存Ticker对象，避免重复创建
- 同一股票的所有数据请求共享一个Ticker实例

**智能退避：**
- 检测到限速后自动标记
- 暂停60秒后自动恢复
- 优先使用缓存数据

#### 1.4 本地缓存机制

**内存缓存：**
- 价格数据：10分钟有效期
- 股票信息：10分钟有效期
- Ticker对象：永久缓存（直到程序重启）

**文件缓存：**
- 位置：`data/cache/{symbol}_history.csv`
- 格式：CSV格式，包含OHLCV数据
- 有效期：1天
- 自动保存：成功获取数据后自动保存
- 自动读取：限速时自动从缓存读取

**缓存策略：**
- 首次获取：从API获取并缓存
- 后续请求：优先使用缓存（如果有效）
- 周期切换：从缓存截取对应周期数据
- 限速时：使用旧缓存数据（即使过期）

---

### 2. 量化策略分析模块 (`app/services/strategy.py`)

量化策略分析模块提供多种技术分析策略和综合评分系统。

#### 2.1 技术指标计算器 (`TechnicalIndicators`)

**支持的指标：**

##### 2.1.1 移动平均线
- **SMA (Simple Moving Average)**：简单移动平均线
  - 周期：5, 10, 20, 60, 200日
  - 用途：判断趋势方向
  
- **EMA (Exponential Moving Average)**：指数移动平均线
  - 周期：12, 26日（MACD用）
  - 用途：对近期价格更敏感

##### 2.1.2 动量指标
- **RSI (Relative Strength Index)**：相对强弱指数
  - 周期：14日
  - 范围：0-100
  - 超买：>70
  - 超卖：<30

- **MACD (Moving Average Convergence Divergence)**：移动平均收敛/发散
  - 快线：12日EMA
  - 慢线：26日EMA
  - 信号线：9日EMA
  - 柱状图：MACD - 信号线

- **KDJ**：随机指标
  - K值：快速随机指标
  - D值：慢速随机指标
  - J值：3K - 2D
  - 超买：>80
  - 超卖：<20

- **威廉%R (Williams %R)**：威廉指标
  - 范围：-100到0
  - 超买：>-20
  - 超卖：<-80

- **CCI (Commodity Channel Index)**：顺势指标
  - 范围：-100到+100
  - 超买：>100
  - 超卖：<-100

##### 2.1.3 波动率指标
- **布林带 (Bollinger Bands)**
  - 中轨：20日SMA
  - 上轨：中轨 + 2倍标准差
  - 下轨：中轨 - 2倍标准差
  - 用途：判断价格波动和超买超卖

- **ATR (Average True Range)**：平均真实范围
  - 周期：14日
  - 用途：衡量价格波动性

##### 2.1.4 趋势指标
- **ADX (Average Directional Index)**：平均趋向指数
  - 范围：0-100
  - 趋势强度：
    - <20：无趋势
    - 20-40：弱趋势
    - 40-60：强趋势
    - >60：极强趋势

##### 2.1.5 成交量指标
- **OBV (On-Balance Volume)**：能量潮
  - 用途：判断成交量与价格的关系

#### 2.2 策略分析器 (`ComprehensiveAnalyzer`)

**三大策略模块：**

##### 2.2.1 趋势策略 (`TrendStrategy`)

**分析维度：**
1. **均线系统**
   - 多头排列：MA5 > MA10 > MA20 > MA60
   - 空头排列：MA5 < MA10 < MA20 < MA60
   - 信号：多头排列→买入，空头排列→卖出

2. **价格位置**
   - 价格相对MA20的位置
   - 信号：高于MA20→强势，低于MA20→弱势

3. **ADX趋势强度**
   - ADX值判断趋势强度
   - 信号：强趋势→跟随，弱趋势→观望

**信号生成：**
- **强烈买入**：多头排列 + 价格高于MA20 + ADX>40
- **买入**：多头排列或价格高于MA20
- **持有**：均线交织，无明显趋势
- **卖出**：空头排列或价格低于MA20
- **强烈卖出**：空头排列 + 价格低于MA20 + ADX>40

##### 2.2.2 动量策略 (`MomentumStrategy`)

**分析维度：**
1. **RSI**
   - 超买：>70 → 卖出信号
   - 超卖：<30 → 买入信号
   - 中性：30-70

2. **MACD**
   - 金叉：MACD上穿信号线 → 买入
   - 死叉：MACD下穿信号线 → 卖出
   - 柱状图：正→买入，负→卖出

3. **KDJ**
   - K值>80：超买
   - K值<20：超卖

4. **威廉%R**
   - >-20：超买
   - <-80：超卖

5. **CCI**
   - >100：超买
   - <-100：超卖

**信号生成：**
- 综合多个动量指标，加权评分
- 多数指标看多→买入信号
- 多数指标看空→卖出信号

##### 2.2.3 波动率策略 (`VolatilityStrategy`)

**分析维度：**
1. **布林带位置**
   - 价格接近上轨：超买，可能回调
   - 价格接近下轨：超卖，可能反弹
   - 价格在中轨附近：正常波动

2. **布林带宽度**
   - 宽度大：高波动，趋势可能延续
   - 宽度小：低波动，可能突破

3. **ATR**
   - ATR高：高波动，风险大
   - ATR低：低波动，风险小

**信号生成：**
- 价格接近下轨 + 布林带宽度正常 → 买入机会
- 价格接近上轨 + 布林带宽度正常 → 卖出机会
- 布林带宽度异常 → 观望

#### 2.3 综合评分系统

**评分权重：**
- 趋势策略：40%
- 动量策略：40%
- 波动率策略：20%

**评分计算：**
```python
综合评分 = (趋势得分 × 0.4) + (动量得分 × 0.4) + (波动率得分 × 0.2)
```

**信号等级：**
- **强烈买入**：评分 > 0.6，置信度 > 70%
- **买入**：评分 > 0.2，置信度 > 50%
- **持有**：评分 -0.2 到 0.2
- **卖出**：评分 < -0.2，置信度 > 50%
- **强烈卖出**：评分 < -0.6，置信度 > 70%

**置信度计算：**
- 基于指标一致性
- 指标一致度高 → 置信度高
- 指标分歧大 → 置信度低

---

### 3. 舆情分析模块 (`app/services/sentiment.py`)

舆情分析模块分析新闻和社交媒体的情绪倾向。

#### 3.1 情绪词典

**英文情绪词典：**
- **正面词汇**：surge, jump, gain, rise, growth, profit, beat, strong, bullish, rally等
- **负面词汇**：drop, fall, decline, loss, miss, weak, bearish, crash, plunge等

**中文情绪词典：**
- **正面词汇**：上涨, 大涨, 暴涨, 涨停, 突破, 新高, 利好, 增长等
- **负面词汇**：下跌, 大跌, 暴跌, 跌停, 破位, 新低, 利空, 下降等

#### 3.2 文本情绪分析 (`analyze_text`)

**分析流程：**
1. 文本预处理（转小写，去除标点）
2. 匹配情绪词典中的词汇
3. 计算正面词汇数和负面词汇数
4. 计算情绪得分：`(正面数 - 负面数) / 总词汇数`
5. 确定情绪类型：
   - 得分 > 0.2 → positive
   - 得分 < -0.2 → negative
   - 其他 → neutral

**返回结果：**
```python
(sentiment, score)
# sentiment: "positive" | "negative" | "neutral"
# score: -1.0 到 1.0
```

#### 3.3 新闻列表分析 (`analyze_news_list`)

**功能：**
- 批量分析多条新闻的情绪
- 为每条新闻添加 `sentiment` 和 `sentiment_score` 字段

**处理流程：**
1. 遍历新闻列表
2. 对每条新闻的标题和摘要进行情绪分析
3. 更新新闻对象的情绪字段

#### 3.4 整体情绪统计 (`get_overall_sentiment`)

**统计指标：**
- **总新闻数**
- **正面新闻数**
- **负面新闻数**
- **中性新闻数**
- **整体情绪**：positive/negative/neutral
- **情绪得分**：加权平均得分

**计算方式：**
```python
整体情绪得分 = Σ(每条新闻得分 × 权重) / 总新闻数
```

#### 3.5 情绪摘要生成 (`generate_sentiment_summary`)

**生成内容：**
- 情绪分布统计
- 关键正面/负面新闻标题
- 情绪趋势分析

**示例输出：**
```
市场情绪：偏多
情绪得分：+0.35
新闻统计：正面15条，负面8条，中性4条

关键正面新闻：
- 公司Q3财报超预期
- 获得大额订单

关键负面新闻：
- 行业监管加强
- 竞争对手推出新产品
```

---

### 4. 股票分析器模块 (`app/services/analyzer.py`)

股票分析器模块整合所有分析功能，生成综合分析报告。

#### 4.1 完整分析流程 (`analyze`)

**分析步骤：**

1. **数据获取**
   - 调用 `DataFetcher.fetch_all_data()` 获取所有数据
   - 包括：价格、新闻、财报、评级、财务数据等

2. **技术指标计算**
   - 计算RSI、MACD、布林带、ATR等指标
   - 计算多条移动平均线（5/10/20/50/200日）

3. **策略分析**
   - 调用 `ComprehensiveAnalyzer` 进行策略分析
   - 生成趋势、动量、波动率三个维度的分析结果

4. **舆情分析**
   - 调用 `SentimentAnalyzer` 分析新闻情绪
   - 生成情绪统计和摘要

5. **机构评级分析**
   - 统计买入/持有/卖出数量
   - 计算机构共识

6. **财报分析**
   - 分析EPS惊喜率
   - 判断财报趋势（持续超预期/不及预期）

7. **关键事件提取**
   - 从新闻中提取高影响事件
   - 从财报中提取重要数据
   - 从评级中提取重大变动

8. **AI摘要生成**
   - 整合所有分析结果
   - 生成结构化的分析报告

9. **数据保存**
   - 保存分析记录到数据库
   - 更新AI上下文

#### 4.2 技术指标计算 (`_calculate_technical_indicators`)

**计算的指标：**
- SMA: 5, 10, 20, 50, 200日
- RSI: 14日
- MACD: 12/26/9
- 布林带: 20日，2倍标准差
- ATR: 14日

**返回数据：**
```python
TechnicalIndicators {
    sma_5: float
    sma_10: float
    sma_20: float
    sma_50: float
    sma_200: float
    rsi_14: float
    macd: float
    macd_signal: float
    macd_hist: float
    bollinger_upper: float
    bollinger_middle: float
    bollinger_lower: float
    atr: float
}
```

#### 4.3 机构评级分析 (`_analyze_analyst_ratings`)

**分析内容：**
- 统计买入/持有/卖出数量
- 计算买入/卖出比例
- 判断机构共识：
  - 买入比例 ≥ 60% → 偏多
  - 卖出比例 ≥ 40% → 偏空
  - 其他 → 中性

**返回数据：**
```python
{
    "total": int           # 总评级数
    "buy": int            # 买入数
    "hold": int           # 持有数
    "sell": int           # 卖出数
    "consensus": str      # 共识（偏多/偏空/中性）
    "buy_pct": float      # 买入比例
    "summary": str        # 摘要文本
}
```

#### 4.4 财报分析 (`_analyze_earnings`)

**分析内容：**
- 统计超预期/不及预期次数
- 计算平均惊喜率
- 判断财报趋势：
  - 超预期次数 ≥ 不及预期次数×2 → 持续超预期
  - 不及预期次数 ≥ 超预期次数×2 → 持续不及预期
  - 其他 → 符合预期

**返回数据：**
```python
{
    "total": int           # 总财报数
    "beat": int           # 超预期次数
    "miss": int           # 不及预期次数
    "avg_surprise": float # 平均惊喜率
    "trend": str          # 趋势（持续超预期/持续不及预期/符合预期）
    "summary": str        # 摘要文本
}
```

#### 4.5 关键事件提取 (`_extract_key_events`)

**提取规则：**

1. **新闻事件**
   - 关键词匹配：收购、合并、拆分、退市、诉讼、召回、破产、裁员等
   - 提取前20条新闻中的高影响事件

2. **财报事件**
   - EPS惊喜率绝对值 > 10%
   - 提取最近2个季度的财报

3. **评级事件**
   - 评级升级/降级
   - 提取最近5条评级变动

**返回数据：**
```python
List[str]  # 事件描述列表，最多10条
```

#### 4.6 AI摘要生成 (`_generate_ai_summary`)

**摘要结构：**

1. **标题和时间**
   - 股票代码和分析时间

2. **价格信息**
   - 当前价格、涨跌幅、成交量

3. **量化策略分析**
   - 综合信号、置信度、综合评分
   - 趋势分析详情
   - 动量分析详情
   - 波动率分析详情

4. **技术指标**
   - RSI、MACD、布林带、ATR

5. **市场情绪**
   - 舆情分析结果
   - 情绪得分和新闻数量

6. **机构评级**
   - 评级统计和共识

7. **财报分析**
   - 财报趋势和惊喜率

8. **关键事件**
   - 最近5条关键事件

9. **分析说明**
   - 免责声明

**示例输出：**
```
【BABA 综合分析报告】
分析时间: 2025-11-29 15:26:00

【价格信息】
当前价格: $157.30
涨跌幅: -0.19 (-0.19%)
成交量: 7,190,000

【量化策略分析】
综合信号: 买入
置信度: 65.2%
综合评分: +0.45

趋势分析:
  • 均线系统: 均线多头排列，短期趋势向上
  • 价格位置: 价格高于MA20 3.2%，强势
  • ADX趋势强度: ADX=38.5，趋势较强

动量分析:
  • RSI: RSI=58.3，偏强势
  • MACD: MACD金叉，柱状图为正
  • KDJ: K=65.2，偏强势

波动率分析:
  • 布林带: 价格位于布林带中轨上方，正常波动
  • 布林带宽度: 布林带宽度正常(15.2%)
  • ATR: ATR=4.32(2.7%)，正常波动

【技术指标】
RSI(14): 58.3
MACD: 0.25
布林带: 152.10 - 157.30 - 162.50
ATR(14): 4.32

【市场情绪】
舆情分析: 偏多
情绪得分: +0.35
新闻数量: 27条

【机构评级】
机构评级: 12买入/5持有/2卖出 (共识:偏多)

【财报分析】
财报: 3次超预期/1次不及预期 (趋势:持续超预期)

【关键事件】
  • [新闻] 公司Q3财报超预期
  • [财报] 2025-11-15: EPS惊喜 +15.2%
  • [评级] 高盛: 买入 (upgrade)

【分析说明】
本分析基于公开数据和技术指标生成，仅供参考，不构成投资建议。
```

---

### 5. AI上下文管理模块 (`app/utils/ai_context.py`)

AI上下文管理模块负责维护每只股票的分析历史，供AI模型读取和理解股票变化趋势。

#### 5.1 上下文数据结构 (`AIContext`)

**数据结构：**
```python
AIContext {
    symbol: str                    # 股票代码
    created_at: datetime          # 创建时间
    updated_at: datetime          # 更新时间
    stock_info_summary: str       # 股票基本信息摘要
    recent_analyses: List[Dict]    # 最近N条分析记录
    key_events_timeline: List[Dict] # 关键事件时间线
    analysis_count: int           # 累计分析次数
    avg_sentiment: float          # 平均情绪得分
    price_trend: str              # 价格趋势（上涨/下跌/震荡）
    user_notes: List[str]         # 用户备注
}
```

#### 5.2 上下文管理功能

##### 5.2.1 创建上下文 (`create_context`)

**功能：**
- 为新股票创建AI上下文
- 初始化基本信息摘要

##### 5.2.2 更新上下文 (`update_context`)

**功能：**
- 添加新的分析记录
- 更新关键事件时间线
- 更新统计信息（分析次数、平均情绪等）
- 更新价格趋势

**更新规则：**
- 保留最近100条分析记录（可配置）
- 保留最近50条关键事件
- 自动计算平均情绪得分
- 根据价格变化判断趋势

##### 5.2.3 添加上下文 (`add_key_event`)

**功能：**
- 添加关键事件到时间线
- 自动记录事件时间戳

##### 5.2.4 生成提示上下文 (`to_prompt_context`)

**功能：**
- 将上下文转换为AI模型可读的文本格式
- 包含：
  - 基本信息摘要
  - 最近5条分析记录
  - 最近10条关键事件
  - 用户备注（最近5条）

**示例输出：**
```
=== BABA 分析上下文 ===
更新时间: 2025-11-29 15:26:00
累计分析: 15次

【基本信息】
Alibaba Group Holding Ltd
US | CONSUMER CYCLICAL | INTERNET RETAIL
市值: 4.38T, PE: 44.62

【近期分析摘要】
- 2025-11-29 15:26:00: 价格157.30 (+0.19%) | RSI(58.3, 偏强势) | 均线多头排列
- 2025-11-28 14:30:00: 价格157.11 (-0.12%) | RSI(56.8, 偏强势) | MACD金叉
- 2025-11-27 16:00:00: 价格157.29 (+0.35%) | RSI(55.2, 中性) | 价格高于MA20

【关键事件】
- 2025-11-29 15:26:00: [新闻] 公司Q3财报超预期
- 2025-11-28 14:30:00: [财报] EPS惊喜 +15.2%
- 2025-11-27 16:00:00: [评级] 高盛: 买入 (upgrade)

【用户备注】
- 关注Q4财报发布时间
- 行业监管政策变化
```

#### 5.3 数据库存储

**表结构：**
```sql
CREATE TABLE ai_contexts (
    id INTEGER PRIMARY KEY,
    symbol TEXT NOT NULL,
    created_at TIMESTAMP,
    updated_at TIMESTAMP,
    stock_info_summary TEXT,
    recent_analyses JSON,
    key_events_timeline JSON,
    analysis_count INTEGER,
    avg_sentiment REAL,
    price_trend TEXT,
    user_notes JSON
);
```

**存储策略：**
- 每只股票一条记录
- 分析记录以JSON格式存储
- 自动更新 `updated_at` 时间戳

---

### 6. 可视化界面模块 (`app/ui.py`)

可视化界面模块提供用户友好的Web界面，展示所有分析结果。

#### 6.1 页面布局

**布局结构：**
- **左侧边栏**：输入控件和系统状态
- **主内容区**：数据展示和分析结果

#### 6.2 侧边栏功能

##### 6.2.1 股票代码输入
- 支持美股代码：`AAPL`, `GOOGL`, `MSFT`
- 支持港股代码：`0700.HK`, `9988.HK` 或 `700`
- 自动解析和标准化

##### 6.2.2 时间周期选择
- **1个月**：~22条数据
- **3个月**：~65条数据
- **6个月**：~130条数据
- **1年**：~252条数据
- **2年**：~504条数据

##### 6.2.3 操作按钮
- **获取数据**：拉取价格、新闻、财报、评级等数据
- **分析**：执行技术分析并保存记录
- **清除缓存**：清除Streamlit缓存，强制刷新数据

##### 6.2.4 系统状态
- 数据库连接状态
- 数据源信息

#### 6.3 主内容区功能

##### 6.3.1 股票头部信息
- 股票名称和代码
- 市场、行业、细分行业

##### 6.3.2 价格指标卡片
- 当前价格（带涨跌箭头）
- 今日最高/最低
- 成交量
- 昨收价

##### 6.3.3 标签页导航

**📊 K线图表标签页：**
- **K线图**：
  - 使用Plotly绘制交互式K线图
  - 显示MA5、MA10、MA20、MA60均线
  - 显示成交量柱状图
  - 支持缩放、平移、下载
  
- **基本面信息**：
  - 市值、PE、PB、股息率

**📰 新闻资讯标签页：**
- **新闻列表**：
  - 显示新闻标题、来源、时间
  - 情绪标签（正面/负面/中性）
  - 点击可跳转到原文
  
- **情绪统计**：
  - 情绪分布饼图
  - 情绪得分趋势

**📈 财报数据标签页：**
- **子标签页1：EPS数据**
  - EPS实际值vs预期值对比表
  - EPS趋势柱状图
  
- **子标签页2：资产负债表**
  - 总资产、总负债、股东权益
  - 现金及等价物
  - 最近4个季度数据
  
- **子标签页3：现金流**
  - 经营现金流、投资现金流、融资现金流
  - 自由现金流
  - 收入报表数据
  
- **子标签页4：机构持有**
  - Top 10机构持有者列表
  - 分析师目标价（最低/最高/均值/中位数）
  - 增长预估（季度/年度）

**🎯 分析师评级标签页：**
- **评级分布图**：
  - 买入/持有/卖出数量饼图
  
- **评级列表**：
  - 机构名称、评级、日期
  - 评级动作（升级/降级/维持）
  - 目标价

**🧠 AI分析标签页：**
- **量化策略分析**（自动显示）：
  - 综合信号卡片（强烈买入/买入/持有/卖出/强烈卖出）
  - 置信度百分比
  - 综合评分
  - 趋势分析详情
  - 动量分析详情
  - 波动率分析详情
  
- **完整分析报告**：
  - 点击"分析"按钮后显示
  - 包含完整AI生成的摘要
  
- **历史上下文**：
  - 显示历史分析记录
  - 关键事件时间线

#### 6.4 图表功能

**K线图特性：**
- 交互式图表（Plotly）
- 支持缩放、平移
- 显示多条均线
- 成交量柱状图
- 可下载为PNG

**情绪分布图：**
- 饼图显示正面/负面/中性新闻比例

**EPS对比图：**
- 柱状图对比实际EPS和预期EPS

**评级分布图：**
- 饼图显示买入/持有/卖出比例

#### 6.5 响应式设计

**自适应布局：**
- 宽屏：侧边栏 + 主内容区
- 窄屏：自动调整布局

**深色主题：**
- 深色背景（#1a1a2e）
- 高对比度文字
- 彩色标签和卡片

---

### 7. 数据库存储模块 (`app/database/`)

数据库存储模块负责持久化存储所有数据和分析结果。

#### 7.1 数据库配置

**数据库类型：**
- SQLite（轻量级，适合个人项目）

**数据库文件：**
- 位置：`data/trading.db`
- 自动创建（如果不存在）

#### 7.2 数据表结构

##### 7.2.1 股票信息表 (`stock_info`)
```sql
CREATE TABLE stock_info (
    id INTEGER PRIMARY KEY,
    symbol TEXT NOT NULL,
    name TEXT,
    market TEXT,
    sector TEXT,
    industry TEXT,
    market_cap REAL,
    pe_ratio REAL,
    pb_ratio REAL,
    dividend_yield REAL,
    description TEXT,
    updated_at TIMESTAMP
);
```

##### 7.2.2 价格数据表 (`stock_prices`)
```sql
CREATE TABLE stock_prices (
    id INTEGER PRIMARY KEY,
    symbol TEXT NOT NULL,
    timestamp TIMESTAMP NOT NULL,
    open REAL,
    high REAL,
    low REAL,
    close REAL,
    volume INTEGER,
    adj_close REAL,
    change REAL,
    change_percent REAL
);
```

##### 7.2.3 新闻数据表 (`stock_news`)
```sql
CREATE TABLE stock_news (
    id INTEGER PRIMARY KEY,
    symbol TEXT NOT NULL,
    title TEXT NOT NULL,
    summary TEXT,
    source TEXT,
    url TEXT,
    published_at TIMESTAMP,
    sentiment TEXT,
    sentiment_score REAL
);
```

##### 7.2.4 分析记录表 (`analysis_records`)
```sql
CREATE TABLE analysis_records (
    id INTEGER PRIMARY KEY,
    symbol TEXT NOT NULL,
    timestamp TIMESTAMP NOT NULL,
    current_price REAL,
    price_change REAL,
    price_change_percent REAL,
    volume INTEGER,
    technical_data JSON,
    sentiment_score REAL,
    sentiment_label TEXT,
    news_count INTEGER,
    ai_summary TEXT
);
```

##### 7.2.5 AI上下文表 (`ai_contexts`)
```sql
CREATE TABLE ai_contexts (
    id INTEGER PRIMARY KEY,
    symbol TEXT NOT NULL UNIQUE,
    created_at TIMESTAMP,
    updated_at TIMESTAMP,
    stock_info_summary TEXT,
    recent_analyses JSON,
    key_events_timeline JSON,
    analysis_count INTEGER DEFAULT 0,
    avg_sentiment REAL,
    price_trend TEXT,
    user_notes JSON
);
```

##### 7.2.6 价格预警表 (`price_alerts`)
```sql
CREATE TABLE price_alerts (
    id INTEGER PRIMARY KEY,
    symbol TEXT NOT NULL,
    alert_type TEXT,
    target_price REAL,
    condition TEXT,
    notified BOOLEAN DEFAULT FALSE,
    created_at TIMESTAMP
);
```

#### 7.3 数据库操作

**连接管理：**
- 使用SQLAlchemy ORM
- 自动连接池管理
- 自动提交事务

**数据操作：**
- 插入：`db.add()` + `db.commit()`
- 查询：`db.query().filter().all()`
- 更新：直接修改对象 + `db.commit()`
- 删除：`db.delete()` + `db.commit()`

---

## 技术特性

### 1. 异步编程

**使用场景：**
- 数据获取（`async/await`）
- 并发请求多个数据源
- 非阻塞IO操作

**优势：**
- 提高响应速度
- 充分利用网络IO等待时间
- 支持并发请求

### 2. 智能缓存

**缓存层级：**
1. **内存缓存**：最快，10分钟有效期
2. **文件缓存**：CSV格式，1天有效期
3. **数据库缓存**：永久存储

**缓存策略：**
- 首次获取：从API获取并缓存
- 后续请求：优先使用缓存
- 限速时：使用旧缓存（即使过期）

### 3. 错误处理和重试

**重试机制：**
- 最多2次重试
-  - 第1次：等待3秒
  - 第2次：等待6秒
- 自动检测限速
- 限速时暂停60秒

**错误处理：**
- 捕获所有异常
- 记录详细日志
- 优雅降级（使用备用数据源）

### 4. 代理支持

**配置方式：**
- 环境变量：`HTTP_PROXY`, `HTTPS_PROXY`
- `.env` 文件配置

**使用场景：**
- 突破网络限制
- 避免IP限速
- 提高数据获取成功率

### 5. 日志系统

**日志级别：**
- `INFO`：正常操作
- `WARNING`：警告信息
- `ERROR`：错误信息
- `DEBUG`：调试信息

**日志输出：**
- 控制台输出
- 文件输出（`logs/` 目录）
- 格式化输出（时间戳、级别、消息）

---

## 使用指南

### 1. 快速开始

**步骤1：安装依赖**
```bash
pip install -r requirements.txt
```

**步骤2：配置API密钥**
- 复制 `env.example` 为 `.env`
- 填入API密钥（可选，yfinance免费）

**步骤3：启动应用**
- 双击 `启动应用.bat`
- 或运行：`python -m streamlit run app/ui.py`

### 2. 基本使用流程

1. **输入股票代码**
   - 在侧边栏输入股票代码（如 `BABA`）
   
2. **选择时间周期**
   - 选择K线数据的时间范围（1个月到2年）
   
3. **获取数据**
   - 点击"获取数据"按钮
   - 等待数据加载完成
   
4. **查看数据**
   - 浏览各个标签页查看不同数据
   - K线图、新闻、财报、评级等
   
5. **执行分析**
   - 点击"分析"按钮
   - 查看AI生成的分析报告
   - 查看量化策略分析结果

### 3. 高级功能

**查看历史分析：**
- 在"AI分析"标签页查看历史上下文
- 查看关键事件时间线

**切换时间周期：**
- 更改时间周期后重新获取数据
- 系统会自动从缓存截取对应周期数据

**清除缓存：**
- 点击"清除缓存"按钮
- 强制刷新所有数据

### 4. 注意事项

**API限速：**
- yfinance限制约2000次/小时
- 建议请求间隔至少1.5秒
- 配置代理可避免限速

**数据延迟：**
- yfinance数据有15分钟延迟
- 实时数据需使用付费API

**数据准确性：**
- 数据来源于公开API
- 仅供参考，不构成投资建议
- 请以官方数据为准

---

## 总结

AITrading 量化分析软件提供了全面的股票分析功能，包括：

✅ **多数据源数据采集**：yfinance、Finnhub、Alpha Vantage  
✅ **量化策略分析**：趋势、动量、波动率三维分析  
✅ **舆情分析**：新闻情绪分析和统计  
✅ **技术指标计算**：RSI、MACD、布林带等10+指标  
✅ **财务数据分析**：资产负债表、现金流、收入报表  
✅ **AI上下文管理**：历史分析记录和关键事件时间线  
✅ **可视化界面**：交互式图表和友好UI  
✅ **智能缓存**：内存+文件+数据库三级缓存  
✅ **错误处理**：重试机制和优雅降级  

### v2.0 新增功能

✅ **自选股管理**：添加、删除、切换自选股票  
✅ **实时监控引擎**：分钟级价格监控，自动刷新  
✅ **价格预警系统**：上下限预警，QQ邮箱通知  
✅ **智能增量更新**：仅拉取缺失数据，避免API浪费  
✅ **冷热数据分层**：静态数据日更，实时数据分钟更  

系统设计注重**单股票深度分析**和**实时监控**，通过多维度数据整合和智能分析，为投资者提供全面的决策支持。

---

**版本信息：** v2.0  
**最后更新：** 2025-11-30  
**作者：** AITrading Team

